{%- macro pkgsetYaml(ps) -%}
{%- for pkg in ps %}
- {{ pkg }}
{% endfor -%}
{%- endmacro -%}

{%- macro pkgsYaml() -%}
{{ pkgsetYaml(pkgs) }}
{% for ps in pkgsets -%}
# {{ ps }}
{{ pkgsetYaml(vars[ps]|default(hostvars[inventory_hostname][ps])) }}
{% endfor -%}
{%- endmacro -%}

architecture: {{arch}}

actions:
  - action: debootstrap
    suite: "sid"
    components:
      - contrib
      - main
      - non-free
    mirror: https://deb.debian.org/debian
    variant: minbase

  - action: run
    chroot: true
    command: |
      cat <<END > /etc/apt/apt.conf.d/70-no-recommends
      APT::Install-Recommends "0";
      APT::Install-Suggests "0";
      END

  - action: apt
    packages:
{{ pkgsYaml()|indent(first=true, width=6) }}

  # todo: hostnamectl?
  - action: run
    chroot: true
    command: "echo {{hostname|default('debos')}} > /etc/hostname"

  #- action: run
  #  chroot: true
  #  command: |
  #    # preseed: tz-data
  #    debconf-set-selections <<TZSEL
  #    tzdata tzdata/Areas select US
  #    tzdata tzdata/Areas seen true
  #    tzdata tzdata/Zones/US select Eastern
  #    tzdata tzdata/Zones/US seen true
  #    TZSEL

  - action: overlay
    origin: "{{VAR}}/overlay"

  - action: run
    chroot: true
    command: ln -sf /proc/self/mounts /etc/mtab

  - actions: run
    chroot: true
    command: |
      # install password
      echo 'root:{{ password|default('CHANGE_OR_ELSE') }}' | chpasswd

  - action: pack
    file: debian.tgz
    compression: gz
