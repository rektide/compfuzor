{% set isGlobal = item is not defined or item.share is not defined %}
{% set share = isGlobal|ternary("global", item.share) %}
{% set filename = isGlobal|ternary("smb", item.share) %}
{% set options = isGlobal|ternary(globalOptions, item.options) %}
# Compfuzor Samba's {{filename}}.conf
# Generated {{TIMESTAMP_CF}}

{% macro globalItem(item) -%}
{% if item.header is defined -%}
{{ headerItem(item) -}}
{% endif -%}
{% if item.comment|default(False) -%}
{{ comment(item) -}}
{% endif -%}
{% if item.option is defined -%}
{{ optionItem(item) -}}
{% endif %}

{% endmacro -%}

{%- macro comment(item) -%}
{% for line in item.comment|arrayitize -%}
# {{line}}
{% endfor -%}
{% endmacro -%}

{%- macro headerItem(item) %}

##### {{item.header}} #####
{%- endmacro -%}

{%- macro optionItem(item) -%}
{% set optionVar = item.option|replace(" ", "_") -%}
{% set optionDef = item.value|default(item.default)|default(item.example)|default("") -%}
{% set optionVal = hostvars[inventory_hostname][optionVar]|default(vars[optionVar])|default(optionDef) -%}
{{ "#" if shareComment|default(false) else "" -}}
{{ "\t" -}}
{{ ";" if item.example is defined else "" -}}
{{ item.option -}}
{{ " = " -}}
{{ "no" if optionVal == False else "" -}}
{{ "yes" if optionVal == True else "" -}}
{{ optionVal if optionVal != True and optionVal != False else "" -}}
{% endmacro %}

[{{share}}]
{% for option in options -%}
{{ globalItem(option) }}
{% endfor -%}
{% if isGlobal %}
# individual shares saved here
include = {{ETC}}/share.d/*.conf
{% endif %}
